<!--index.wxml-->
<view class="page">
  <!-- é¡¶éƒ¨è“è‰²èƒŒæ™¯ -->
  <view class="header-bg" style="position: relative; left: -2rpx; top: -2rpx; height: 443rpx; display: flex; box-sizing: border-box; width: 780rpx">
    <view class="header-decoration left" style="width: 450rpx; display: block; box-sizing: border-box; left: -80rpx; top: -80rpx"></view>
    <view class="header-decoration right" style="position: absolute; left: 514rpx; top: 21rpx"></view>
    <view class="title-container" style="position: relative; left: 30rpx; top: -74rpx">
    </view>
  </view>

  <scroll-view class="scrollarea" scroll-y type="list" enhanced show-scrollbar="{{false}}" style="position: relative; left: -3rpx; top: 80rpx">
    <!-- é¡¶éƒ¨è½®æ’­å›¾ -->
    <swiper class="banner-swiper" indicator-dots="{{true}}" indicator-color="rgba(255,255,255,0.3)" indicator-active-color="#ffffff" autoplay="{{true}}" interval="3000" duration="500" circular="{{true}}" wx:if="{{banners.length > 0}}" style="height: 352rpx; display: block; box-sizing: border-box">
      <swiper-item wx:for="{{banners}}" wx:key="index" bindtap="onBannerTap" data-index="{{index}}" style="height: 330rpx; display: block; box-sizing: border-box; left: 0rpx; top: 0rpx">
        <image src="{{item.imageUrl}}" mode="aspectFill" class="banner-image" style="height: 356rpx; display: inline-block; box-sizing: border-box; position: relative; left: 0rpx; top: -2rpx"></image>
        <view class="banner-overlay" style="height: 176rpx; display: block; box-sizing: border-box; left: -1rpx; top: 179rpx; position: absolute"></view>
        <view class="banner-text">
          <view class="banner-title">{{item.title}}</view>
          <view class="banner-subtitle">{{item.subtitle}}</view>
        </view>
      </swiper-item>
    </swiper>
    <!-- å¿«æ·åŠŸèƒ½åŒº - ä»…ç®¡ç†å‘˜å¯è§ -->
    <!-- <view class="features-card" wx:if="{{hasUserInfo && userInfo.isAdmin}}">  -->
    <!-- å¿«æ·åŠŸèƒ½åŒº - æ‰€æœ‰äººå¯è§ -->
    <view class="features-card" wx:if="{{hasUserInfo}}">
      <view class="feature-row">
        <view class="feature-item" bindtap="goToProfile">
          <view class="feature-icon profile-bg" style="width: 324rpx; display: flex; box-sizing: border-box; position: relative; left: -26rpx; top: 2rpx">
            <view class="feature-text-content">
              <text class="feature-title">æˆ‘çš„èµ„æ–™</text>
              <text class="feature-subtitle">æŸ¥çœ‹å’Œç¼–è¾‘ä¸ªäººä¿¡æ¯</text>
            </view>
            <image src="/images/assistant.png" class="feature-logo"></image>
          </view>
        </view>
        <view class="feature-item" bindtap="goToInvite">
          <view class="feature-icon invite-bg" style="width: 324rpx; display: flex; box-sizing: border-box">
            <view class="feature-text-content">
              <text class="feature-title">å‘èµ·é‚€çº¦</text>
              <text class="feature-subtitle">åˆ›å»ºæ–°çš„æ´»åŠ¨é‚€è¯·</text>
            </view>
            <image src="/images/wechat.png" class="feature-logo"></image>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ - å·²ç™»å½•çŠ¶æ€ -->
    <view class="user-card" wx:if="{{hasUserInfo}}">
      <!-- ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ† -->
      <view class="user-info-top-section">
        <view class="user-info">
          <image class="avatar" src="{{userInfo.avatarUrl || '/images/avatar1.jpg'}}"></image>
          <view class="user-details">
            <view class="username">{{userInfo.name && userInfo.name.trim() !== '' ? userInfo.name : 'æœªè®¾ç½®åç§°'}}</view>
            <view class="admin-badge" wx:if="{{userInfo.isAdmin}}" style="font-size: 24rpx; color: #1989fa; background: rgba(25, 137, 250, 0.1); padding: 4rpx 12rpx; border-radius: 20rpx; display: inline-block; margin-top: 8rpx;">ç®¡ç†å‘˜</view>
          </view>
        </view>
        <button class="edit-profile-btn" bindtap="goToProfile">ç¼–è¾‘èµ„æ–™</button>
      </view>
      
      <!-- èµ„æ–™å®Œå–„è¿›åº¦æ¡ -->
      <view class="profile-progress-section">
        <view class="progress-label">
          <text class="progress-text">èµ„æ–™å®Œå–„åº¦</text>
          <text class="progress-percentage">{{profileProgress}}%</text>
          <text class="progress-tip" wx:if="{{profileProgress < 100}}">å®Œå–„èµ„æ–™ï¼Œè®©å…¶ä»–äººæ›´äº†è§£ä½ </text>
        </view>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{profileProgress}}%"></view>
        </view>
      </view>
      

    </view>
    
    <!-- æœªç™»å½•çŠ¶æ€æç¤º -->
    <view class="login-prompt-card" wx:else>
      <view class="login-prompt-content">
        <image class="login-prompt-image" src="/images/login.png" mode="aspectFit"></image>
        <view class="login-prompt-text">ç™»å½•è·å¾—å¿ƒå…‰é‚€çº¦AIåŠ©æ‰‹æœåŠ¡</view>
        <button class="login-prompt-button" bindtap="goToLogin">å»ç™»å½•</button>
      </view>
    </view>

    <!-- æ´»åŠ¨å¤§å…åˆ—è¡¨ - ç›´æ¥æ˜¾ç¤ºæ´»åŠ¨ -->
    <view class="events-section">
      <view class="section-header" style="width: 690rpx; display: flex; box-sizing: border-box">
        <view class="section-title" style="position: relative; left: 29rpx; top: 20rpx">
          <text class="title-icon">ğŸª</text>
          æ´»åŠ¨å¤§å…
        </view>
        <view class="section-more" bindtap="goToEvents" style="padding: 10rpx 20rpx; position: relative; left: 1rpx; top: 9rpx">æ›´å¤š></view>
      </view>
      
      <!-- æ ‡ç­¾å¯¼èˆª -->
      <view class="tabs-card">
        <view class="tabs">
          <view 
            class="tab-item {{activeEventTab === index ? 'active' : ''}}" 
            wx:for="{{eventTabs}}" 
            wx:key="*this" 
            data-index="{{index}}" 
            bindtap="switchEventTab">
            {{item}}
          </view>
        </view>
      </view>
      
      <!-- æ´»åŠ¨å†…å®¹åŒº -->
      <view class="events-content">
        <!-- åŠ è½½ä¸­çŠ¶æ€ -->
        <view class="loading-container" wx:if="{{loading.eventsLobby}}">
          <image class="loading-image" src="/images/ai-loading.gif"></image>
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
        
        <!-- æ´»åŠ¨åˆ—è¡¨ -->
        <view class="events-list">
          <view class="empty-state" wx:if="{{!loading.eventsLobby && events.length === 0}}">
            <image class="empty-image" src="/images/empty.png"></image>
            <view class="empty-text">æš‚æ— æ´»åŠ¨</view>
          </view>
          
          <view class="event-card" wx:for="{{events}}" wx:key="_id" bindtap="viewEventDetail" data-id="{{item._id}}">
            <image class="event-cover" src="{{item.cover || '/images/default_event.jpg'}}" mode="aspectFill"></image>
            <view class="event-type-badge {{item.isExpired ? 'expired-badge' : ''}}">
              {{item.isExpired ? 'è¿‡æœŸæ´»åŠ¨' : (item.type || 'çƒ­é—¨æ´»åŠ¨')}}
            </view>
            
            <view class="event-info">
              <view class="event-title">{{item.title || 'æœªå‘½åæ´»åŠ¨'}}</view>
              
              <!-- æ–°å¢ï¼šæ˜¾ç¤ºæ´»åŠ¨æ ‡ç­¾ -->
              <view class="event-tags" wx:if="{{item.tags && item.tags.length > 0}}">
                <view wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this" class="event-tag">{{tag}}</view>
              </view>
              
              <view class="event-details">
                <view class="event-time">
                  <text class="event-icon time-icon"></text>
                  <text>{{item.date}} {{item.time || ''}}</text>
                </view>
                <view class="event-location" wx:if="{{item.location}}">
                  <text class="event-icon location-icon"></text>
                  <text>{{item.location}}</text>
                </view>
                <view class="event-attendees">
                  <text class="event-icon user-icon"></text>
                  <text>{{item.participants.length || 0}}äººå‚ä¸</text>
                </view>
              </view>
              
              <!-- æŒ‰é’®åŒºåŸŸ -->
              <view class="event-buttons">
                <!-- åˆ†äº«å›¾æ ‡æŒ‰é’® -->
                <button class="share-icon-btn" open-type="share" data-event="{{item}}" data-event-id="{{item._id}}" catchtap="onShareButtonTap" style="width: 68rpx; display: flex; box-sizing: border-box; left: 0rpx; top: 0rpx">
                  <text class="share-icon"></text>
                </button>
                
                <!-- æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒæŒ‰é’® -->
                <block wx:if="{{item.isCreator}}">
                  <button class="edit-btn" catch:tap="editEvent" data-id="{{item._id}}" style="width: 152rpx; display: flex; box-sizing: border-box; left: 0rpx; top: 0rpx">ç¼–è¾‘æ´»åŠ¨</button>
                </block>
                <block wx:else>
                  <!-- åˆ¤æ–­æ˜¯å¦ä¸ºè¿‡æœŸæ´»åŠ¨ -->
                  <block wx:if="{{item.isExpired}}">
                    <button class="expect-btn" catch:tap="expectRerun" data-id="{{item._id}}" data-name="{{item.title}}">
                      æœŸå¾…åŠ åœº
                    </button>
                  </block>
                  <block wx:else>
                    <button class="join-btn {{item.isJoined ? 'joined-btn' : ''}}" 
                            catch:tap="toggleJoin" 
                            data-id="{{item._id}}">
                      {{item.isJoined ? 'å–æ¶ˆæŠ¥å' : 'ç«‹å³æŠ¥å'}}
                    </button>
                  </block>
                </block>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
  


  <!-- å°åŠ©ç†æ‚¬æµ®æŒ‰é’® -->
  <floating-assistant bind:toggleChat="onChatToggle" bind:sendMessage="onChatSendMessage" />

  <!-- Topic Survey Modal Component -->
  <topic-survey-modal 
    show="{{showIndexSurveyModal}}" 
    survey="{{currentIndexSurveyData}}" 
    bind:close="onIndexSurveyModalClose" 
    bind:submit="onIndexSurveyModalSubmit"
  />
</view>
