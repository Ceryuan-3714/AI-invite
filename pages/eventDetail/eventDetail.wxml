<!-- eventDetail.wxml -->
<view class="container">


  <!-- æ´»åŠ¨å†…å®¹ -->
  <scroll-view class="event-content" scroll-y wx:if="{{!loading}}">
    <!-- æ´»åŠ¨å°é¢å’Œæ ‡é¢˜ - æ”¹è¿›ä¸ºæ²‰æµ¸å¼è®¾è®¡ -->
    <view class="event-banner">
      <image class="banner-bg" src="{{event.cover}}" mode="aspectFill"></image>
      <view class="banner-gradient-overlay" style="height: 480rpx; display: block; box-sizing: border-box; left: 1rpx; top: -1rpx; position: absolute"></view>
      <view class="banner-content">
      <view class="event-title" style="position: relative; left: 1rpx; top: -25rpx">{{event.title}}</view>
      <view class="event-tags" wx:if="{{event.tags && event.tags.length > 0}}" style="position: relative; left: -1rpx; top: -40rpx">
        <view class="event-tag" wx:for="{{event.tags}}" wx:key="*this">{{item}}</view>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ - æ”¹ä¸ºå¡ç‰‡å¼è®¾è®¡ -->
    <view class="info-card">
      <view class="info-item">
        <view class="info-icon-container">
        <view class="info-icon date-icon"></view>
        </view>
        <view class="info-content">
          <text class="info-label">æ—¶é—´</text>
        <text class="info-value">{{event.date}} {{event.time}}</text>
        </view>
      </view>
      
      <view class="info-divider"></view>
      
      <view class="info-item">
        <view class="info-icon-container">
        <view class="info-icon location-icon"></view>
        </view>
        <view class="info-content">
          <text class="info-label">åœ°ç‚¹</text>
        <text class="info-value">{{event.location}}</text>
        </view>
      </view>
      
      <view class="info-divider"></view>
      
      <view class="info-item">
        <view class="info-icon-container">
        <view class="info-icon people-icon"></view>
        </view>
        <view class="info-content">
          <view class="people-info-row">
            
            <!-- å‚ä¸è€…æ°”æ³¡æ ‡ç­¾ -->
            <view class="participant-bubbles-area" bindtap="scrollToParticipants">
              <view class="participant-bubbles-container">
                <view class="participant-bubble participant-bubble-{{index % 4}}" wx:for="{{participantsDetails}}" wx:key="openid" wx:if="{{index < 19}}">
                  <image class="bubble-avatar" src="{{item.avatarUrl || item.avatar || '/images/default-avatar.png'}}"></image>
                  <text class="bubble-name">{{item.name && item.name.trim() !== '' ? item.name : 'æœªè®¾ç½®åç§°'}}</text>
                </view>
                <view class="more-participants-bubble" wx:if="{{participantsDetails.length > 19}}">
                  <text>ç­‰{{event.currentAttendees || 0}}äºº</text>
                </view>
                <view class="arrow-down-container">
                  <view class="arrow-down"></view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨æè¿° -->
    <view class="section description-section">
      <view class="section-header">
        <text class="section-title">æ´»åŠ¨æè¿°</text>
      </view>
      <view class="section-content">
        <text class="description-content">{{event.description}}</text>
        
        <!-- æ´»åŠ¨æè¿°å›¾ç‰‡å±•ç¤º -->
        <view class="description-images-display" wx:if="{{event.descriptionImages && event.descriptionImages.length > 0}}">
          <view class="description-image-item" wx:for="{{event.descriptionImages}}" wx:key="index">
            <image class="description-image" src="{{item}}" mode="widthFix" bindtap="previewDescriptionImage" data-index="{{index}}"></image>
          </view>
        </view>
      </view>
    </view>

    <!-- ç­¾åˆ°äºŒç»´ç ç”ŸæˆæŒ‰é’® - ä»…æ´»åŠ¨å‘èµ·è€…ä¸”å¼€å¯ç­¾åˆ°åŠŸèƒ½æ—¶æ˜¾ç¤º -->
    <view wx:if="{{isCreator && checkinConfig && checkinConfig.enabled}}" class="section checkin-generate-section">
      <view class="section-content">
        <button class="btn generate-checkin-qr-btn" bindtap="generateCheckinQRCode" loading="{{qrCodeLoading}}">
          {{qrCodeLoading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆç­¾åˆ°äºŒç»´ç '}}
        </button>
        <text class="checkin-qr-tip">ç”ŸæˆäºŒç»´ç ä¾›å‚ä¸è€…æ‰«æç­¾åˆ°</text>
      </view>
    </view>

    <!-- äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ - ä»…åˆ›å»ºè€…å¯è§ -->
    <view wx:if="{{isCreator && qrCodeUrl}}" class="section qr-code-section">
      <view class="section-header">
        <text class="section-title">ç­¾åˆ°äºŒç»´ç </text>
      </view>
      <view class="section-content qr-code-content">
        <image class="checkin-qrcode-image" src="{{qrCodeUrl}}" mode="aspectFit" bindtap="previewQRCode"></image>
        <text class="qr-code-tip">å‚ä¸è€…å¯æ‰«ææ­¤äºŒç»´ç è¿›è¡Œç­¾åˆ°ï¼Œé•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜</text>
        

        
        <view class="qr-code-link-container" wx:if="{{qrCodePath}}">
          <text class="qr-code-link-label">äºŒç»´ç è·³è½¬è·¯å¾„ï¼š</text>
          <text class="qr-code-link-text" user-select="true" bindtap="navigateToQRCodePath">{{qrCodePath}}</text>
        </view>
        <view class="qr-buttons-container">
          <button class="btn regenerate-qr-btn" bindtap="generateCheckinQRCode" loading="{{qrCodeLoading}}" wx:if="{{showGenerateQRButton}}">
            {{qrCodeLoading ? 'ç”Ÿæˆä¸­...' : 'é‡æ–°ç”ŸæˆäºŒç»´ç '}}
          </button>
          <button class="btn view-checkin-btn" bindtap="viewCheckinList">æŸ¥çœ‹å·²ç­¾åˆ°äººå‘˜</button>
        </view>
      </view>
    </view>

    <!-- å‚ä¸äººå‘˜ä¸åˆä½œå»ºè®®åˆå¹¶ -->
    <view class="section participants-section">
      <view class="section-header">
        <text class="section-title">å‚ä¸äººå‘˜åŠåˆä½œå»ºè®®</text>
        <view class="refresh-btn" bindtap="refreshAISuggestions" wx:if="{{!loadingAI && isLoggedIn}}">
          <text class="refresh-icon">â†»</text>
          <text class="refresh-text">åˆ·æ–°å»ºè®®</text>
        </view>
        <view class="login-btn" bindtap="promptLogin" wx:if="{{!isLoggedIn}}">
          <text class="login-icon">ğŸ”‘</text>
          <text class="login-text">ç™»å½•æŸ¥çœ‹</text>
        </view>
      </view>
      <view class="section-content">
        <!-- æ´»åŠ¨åˆ›å»ºè€…ä¿¡æ¯å¡ç‰‡ -->
        <view class="creator-card" wx:if="{{event.creatorInfo}}" bindtap="onOrganizerTap">
            <view class="participant-item">
              <image class="participant-avatar" src="{{event.creatorInfo.avatarUrl || event.creatorInfo.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
              <view class="participant-info">
                <view class="participant-name-row">
                  <text class="participant-name">{{event.creatorInfo.name && event.creatorInfo.name.trim() !== '' ? event.creatorInfo.name : 'æœªè®¾ç½®åç§°'}}</text>
                  <view class="participant-badge creator">ç»„ç»‡è€…</view>
                </view>
                <text class="participant-title">{{event.creatorInfo.companyPositionText || ''}}</text>
              </view>
            </view>
            
            <!-- ç»„ç»‡è€…AIå»ºè®®åŒºåŸŸ -->
            <view class="ai-suggestion-container" wx:if="{{isLoggedIn && event.creatorInfo.openid !== userInfo.openid}}">
              <block wx:if="{{event.creatorInfo.aiSuggestion.loading}}">
                <view class="ai-loading-item individual-loading">
                  <image class="ai-loading-icon small-loading-icon" src="/images/ai-ai-loading.gif"></image>
                  <text class="ai-loading-text small-loading-text">AIæ­£åœ¨ä¸ºç»„ç»‡è€…ç”Ÿæˆå»ºè®®ä¸­...</text>
                </view>
              </block>
              <block wx:elif="{{event.creatorInfo.aiSuggestion && event.creatorInfo.aiSuggestion.content}}">
                <view class="ai-suggestion-content">
                  <view class="suggestion-header">
                    <view class="suggestion-type {{event.creatorInfo.aiSuggestion.typeClass || 'default'}}">{{event.creatorInfo.aiSuggestion.type || 'åˆä½œå»ºè®®'}}</view>
                    <text class="suggestion-title">{{event.creatorInfo.aiSuggestion.title || 'åˆä½œå»ºè®®'}}</text>
                  </view>
                  <text class="suggestion-text">{{event.creatorInfo.aiSuggestion.content}}</text>
                  <!-- æ–°å¢ï¼šæ ‡ç­¾åˆ—è¡¨ -->
                  <view class="suggestion-tags" wx:if="{{event.creatorInfo.aiSuggestion.tips.length > 0}}">
                    <view class="tag-item" wx:for="{{event.creatorInfo.aiSuggestion.tips}}" wx:key="*this">
                      {{item}}
                    </view>
                  </view>
                </view>
              </block>
              <block wx:elif="{{event.creatorInfo.aiSuggestion.error}}">
                <view class="ai-error-item">
                  <view class="ai-error-content">
                    <text class="ai-error-text">AIè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•</text>
                    <view class="single-refresh-btn" catchtap="refreshCreatorAISuggestion">
                      <text class="single-refresh-icon">â†»</text>
                      <text class="single-refresh-text">é‡æ–°ç”Ÿæˆ</text>
                    </view>
                  </view>
                </view>
              </block>
              <block wx:else>
                <view class="ai-loading-item individual-loading">
                  <text class="ai-loading-text small-loading-text">æš‚æ— AIå»ºè®®æˆ–è¿æ¥å¤±è´¥</text>
                </view>
              </block>
            </view>
            
            <!-- æœªç™»å½•çŠ¶æ€çš„AIå»ºè®®æç¤º -->
            <view class="ai-suggestion-container" wx:if="{{!isLoggedIn}}">
              <view class="ai-login-needed">
                <view class="login-prompt">
                  <text class="login-prompt-text">ç™»å½•åæŸ¥çœ‹ä¸ºæ‚¨å®šåˆ¶çš„AIåˆä½œå»ºè®®</text>
                  <button class="login-prompt-btn" bindtap="promptLogin">ç«‹å³ç™»å½•</button>
                </view>
              </view>
            </view>
        </view>
        
        <view class="participants-list" style="margin-top: 48rpx;">
          <view class="participants-header">
            <text class="participants-title" style="position: relative; left: -17rpx; top: -3rpx">æ´»åŠ¨å‚ä¸è€…</text>
            <text class="participants-count">({{participantsDetails.length}}äºº)</text>
            <view class="view-all-link" bindtap="viewAllParticipants" style="width: 150rpx; display: block; box-sizing: border-box; position: relative; left: 98rpx; top: -6rpx">æŸ¥çœ‹å…¨éƒ¨></view>
          </view>
          
          <view class="empty-tip" wx:if="{{!participantsDetails || participantsDetails.length === 0}}">
            <text class="empty-text">æš‚æ— å‚ä¸äººå‘˜</text>
          </view>
          <view class="participant-card" wx:for="{{participantsDetails}}" wx:key="openid" bindtap="onParticipantTap" data-participant-index="{{index}}" wx:if="{{item.openid !== event.creatorOpenid}}">
            <!-- å‚ä¸è€…ä¿¡æ¯ -->
            <view class="participant-item">
            <image class="participant-avatar" src="{{item.avatarUrl || item.avatar || '/images/default-avatar.png'}}"></image>
            <view class="participant-info">
                <view class="participant-name-row">
              <text class="participant-name">{{item.name && item.name.trim() !== '' ? item.name : 'æœªè®¾ç½®åç§°'}}</text>
                </view>
              <text class="participant-title">{{item.companyPositionText || ((item.company || '') + ' ' + (item.position || ''))}}</text>
              </view>
              <!-- ç‚¹å‡»æç¤ºåŠ¨ç”» -->
              <view class="click-animation-container" wx:if="{{item.showClickHint}}">
                <view class="click-ripple"></view>
              </view>
            </view>
            
            <!-- AIå»ºè®®åŒºåŸŸ -->
            <view class="ai-suggestion-container" wx:if="{{isLoggedIn && item.openid !== userInfo.openid}}">
              <block wx:if="{{item.aiSuggestion.loading}}">
                <view class="ai-loading-item individual-loading">
                  <image class="ai-loading-icon small-loading-icon" src="/images/ai-ai-loading.gif"></image>
                  <text class="ai-loading-text small-loading-text">AIæ­£åœ¨ä¸ºTAç”Ÿæˆå»ºè®®ä¸­...</text>
                </view>
              </block>
              <block wx:elif="{{item.aiSuggestion && item.aiSuggestion.content}}">
                <view class="ai-suggestion-content">
              <view class="suggestion-header">
                    <!-- <view class="suggestion-type {{item.aiSuggestion.typeClass || 'default'}}">{{item.aiSuggestion.type || 'åˆä½œå»ºè®®'}}</view> -->
                    <text class="suggestion-title">{{item.aiSuggestion.title || 'åˆä½œå»ºè®®'}}</text>
                  </view>
                  <text class="suggestion-text">{{item.aiSuggestion.content}}</text>
                  <!-- æ–°å¢ï¼šæ ‡ç­¾åˆ—è¡¨ -->
                  <view class="suggestion-tags" wx:if="{{item.aiSuggestion.tips.length > 0}}">
                    <view class="tag-item" wx:for="{{item.aiSuggestion.tips}}" wx:key="*this" wx:for-item="tag">
                      {{tag}}
                    </view>
                  </view>
                </view>
              </block>
              <block wx:elif="{{item.aiSuggestion.error}}">
                <view class="ai-error-item">
                  <view class="ai-error-content">
                    <text class="ai-error-text">AIè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•</text>
                    <view class="single-refresh-btn" catchtap="refreshSingleAISuggestion" data-participant-index="{{index}}">
                      <text class="single-refresh-icon">â†»</text>
                      <text class="single-refresh-text">é‡æ–°ç”Ÿæˆ</text>
                    </view>
                  </view>
                </view>
              </block>
              <block wx:else>
                <view class="ai-loading-item individual-loading">
                  <text class="ai-loading-text small-loading-text">æš‚æ— AIå»ºè®®æˆ–è¿æ¥å¤±è´¥</text>
                </view>
              </block>
            </view>
            
            <!-- æœªç™»å½•çŠ¶æ€çš„AIå»ºè®®æç¤º -->
            <view class="ai-suggestion-container" wx:if="{{!isLoggedIn}}">
              <view class="ai-login-needed">
                <view class="login-prompt">
                  <text class="login-prompt-text">ç™»å½•åæŸ¥çœ‹ä¸ºæ‚¨å®šåˆ¶çš„AIåˆä½œå»ºè®®</text>
                  <button class="login-prompt-btn" bindtap="promptLogin">ç«‹å³ç™»å½•</button>
                </view>
              </view>
            </view>
          </view>
          <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
          <view class="load-more-container" wx:if="{{hasMoreParticipants}}">
            <button class="load-more-btn" bindtap="loadMoreParticipants" loading="{{loadingMoreParticipants}}">
              {{loadingMoreParticipants ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—§çš„AIåˆä½œæœºä¼šå»ºè®®éƒ¨åˆ†å°†è¢«ç§»é™¤ -->

  </scroll-view>

  <!-- åº•éƒ¨æŒ‰é’® - å¢åŠ æ¸å˜æ•ˆæœ -->
  <view class="footer">
    <button class="share-btn" open-type="share">
      <text class="btn-icon">â†—</text>
      <text class="btn-text">åˆ†äº«</text>
    </button>
    <block wx:if="{{isCreator}}">
      <button class="action-btn edit-btn" bindtap="editEvent">ç¼–è¾‘</button>
      <button class="action-btn share-code-btn" bindtap="goToQRCodeManagement">åˆ†äº«ç </button>
      <button class="action-btn cancel-btn" bindtap="cancelEvent">å–æ¶ˆæ´»åŠ¨</button>
    </block>
    <block wx:else>
      <button class="action-btn {{event.isJoined ? 'leave-btn' : 'join-btn'}}" bindtap="toggleJoin">
        {{event.isJoined ? 'å–æ¶ˆæŠ¥å' : 'ç«‹å³æŠ¥å'}}
      </button>
      <!-- å‚ä¸è€…ï¼šç­¾åˆ°æŒ‰é’® -->
      <button class="action-btn checkin-btn {{!canCheckin ? 'disabled': ''}}" wx:if="{{showCheckinButton}}" bindtap="handleCheckin" disabled="{{!canCheckin}}">
        {{checkinButtonText}}
      </button>
    </block>
  </view>
  
  <!-- å°åŠ©ç†æ‚¬æµ®æŒ‰é’®
  <floating-assistant bind:toggleChat="onChatToggle" bind:sendMessage="onChatSendMessage" /> -->

  <!-- ---- START: Topic Survey Modal ---- -->
  <view class="modal-mask" wx:if="{{showTopicSurveyModal}}" bindtap="closeTopicSurveyModal"></view>
  <view class="modal-dialog topic-survey-modal" wx:if="{{showTopicSurveyModal}}">
    <view class="modal-header">
      <text class="modal-title">å‚ä¸è¯é¢˜æ„æ„¿è°ƒæŸ¥</text>
      <view class="modal-close-btn" bindtap="closeTopicSurveyModal">Ã—</view>
    </view>
    <view class="modal-content">
      <view class="survey-question-text">{{currentSurvey.question}}</view>
      <radio-group class="survey-options-group" bindchange="handleSurveyOptionChange">
        <label class="survey-option-label" wx:for="{{currentSurvey.options}}" wx:key="index" wx:for-item="optionItem">
          <radio class="survey-option-radio" 
            value="{{optionItem.value}}" 
            checked="{{currentSurvey.selectedOptionText === optionItem.value}}"/>
          <text class="survey-option-text">{{optionItem.text}}</text>
        </label>
      </radio-group>
      <view class="empty-selection-tip" wx:if="{{!currentSurvey.selectedOptionText && surveySubmitAttempted}}">è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</view>
    </view>
    <view class="modal-footer">
      <button class="btn modal-btn cancel-btn" bindtap="closeTopicSurveyModal">ç¨åå¡«å†™</button>
      <button class="btn modal-btn confirm-btn" bindtap="submitTopicSurvey">ç¡®è®¤</button>
    </view>
  </view>
  <!-- ---- END: Topic Survey Modal ---- -->



</view>